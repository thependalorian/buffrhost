name: Security Analysis

on:
  workflow_call:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run npm audit
        run: |
          cd frontend
          npm audit --audit-level=moderate

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          cd backend
          bandit -r . -f json -o bandit-results.json || true
          bandit -r . -f txt | tee bandit-results.txt || true

  # Critical Security Checks
  critical-security-checks:
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Check for hardcoded passwords
        run: |
          echo "üîç Checking for hardcoded passwords..."
          if grep -r "password123\|password\|secret" frontend/app/api/ --include="*.ts" --include="*.js"; then
            echo "‚ùå CRITICAL: Hardcoded passwords found!"
            exit 1
          else
            echo "‚úÖ No hardcoded passwords found"
          fi

      - name: Check for SQL injection vulnerabilities
        run: |
          echo "üîç Checking for SQL injection vulnerabilities..."
          if grep -r "SELECT.*\+.*FROM\|INSERT.*\+.*INTO\|UPDATE.*\+.*SET\|DELETE.*\+.*FROM" frontend/app/api/ --include="*.ts" --include="*.js"; then
            echo "‚ö†Ô∏è WARNING: Potential SQL injection vulnerabilities found!"
            echo "Please review and use parameterized queries"
          else
            echo "‚úÖ No obvious SQL injection patterns found"
          fi

      - name: Check for missing input validation
        run: |
          echo "üîç Checking for input validation..."
          if ! grep -r "zod\|joi\|yup" frontend/app/api/ --include="*.ts" --include="*.js"; then
            echo "‚ö†Ô∏è WARNING: No validation libraries found in API routes"
          else
            echo "‚úÖ Validation libraries found"
          fi

      - name: Check for rate limiting
        run: |
          echo "üîç Checking for rate limiting implementation..."
          if ! grep -r "rate.*limit\|throttle\|limiter" frontend/app/api/ --include="*.ts" --include="*.js"; then
            echo "‚ö†Ô∏è WARNING: No rate limiting found in API routes"
          else
            echo "‚úÖ Rate limiting found"
          fi

      - name: Security summary
        run: |
          echo "üîê Security Analysis Summary"
          echo "=========================="
          echo "‚úÖ Dependency audit completed"
          echo "‚úÖ Python security scan completed"
          echo "‚úÖ Critical security checks completed"
          echo ""
          echo "üìã Security Recommendations:"
          echo "1. Replace hardcoded password validation with bcrypt"
          echo "2. Use parameterized queries for all database operations"
          echo "3. Implement rate limiting on all endpoints"
          echo "4. Add comprehensive input validation"
          echo "5. Implement security event logging"
